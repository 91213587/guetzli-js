<!DOCTYPE html>

<html>
<head>
	<title>Hello</title>

	<script src="./jquery.min.js"></script>
	<script src="./FileSaver.js"></script>
</head>

<body>
<div id='guetzli-version'> loading ... </div>
<canvas id="myCanvas" width="120" height="80">show image</canvas>
<div><button id="saveAsBtnRun">Save As...</button></div>

<script>if(!window.module) { window.module = {}; }</script>
<script src='./guetzli.out.js'></script>

<script>
// CAPI_EXPORT(guetzli_string_t*) guetzli_string_new(int size);
function guetzli_string_new(size) {
	return Module.ccall('guetzli_string_new', 'number',
		['number'],
		[size]
	)
}

// CAPI_EXPORT(void) guetzli_string_delete(guetzli_string_t* p);
function guetzli_string_delete(p) {
	Module.ccall('guetzli_string_delete', 'null',
		['number'],
		[p]
	)
}

// CAPI_EXPORT(void) guetzli_string_resize(guetzli_string_t* p, int size);
function guetzli_string_resize(p, size) {
	return Module.ccall('guetzli_string_resize', 'null',
		['number', 'number'],
		[p, size]
	)
}

// CAPI_EXPORT(int) guetzli_string_size(guetzli_string_t* p);
function guetzli_string_size(p) {
	return Module.ccall('guetzli_string_size', 'number',
		['number'],
		[p]
	)
}

// CAPI_EXPORT(char*) guetzli_string_data(guetzli_string_t* p);
function guetzli_string_data(p) {
	return Module.ccall('guetzli_string_data', 'number',
		['number'],
		[p]
	)
}

function guetzliGetVersion() {
	return Module.ccall('guetzliGetVersion', 'string',
		[],
		[]
	)
}

function guetzli_encode_RGBA(pix, w, h, stride, quality) {
	return Module.ccall('guetzli_encode_RGBA', 'number',
		['array', 'number', 'number', 'number', 'number'],
		[pix, w, h, stride, quality]
	)
}

function cToUint8Array(p, size) {
	var q = new Uint8Array(size|0)
	for(var i = 0; i < q.length; i++) {
		q[i] = Module.HEAPU8[p+i]
	}
	return q
}

function encodeImage(id) {
	console.log("encodeImage:", '1')

	var canvas = document.getElementById(id)
	var ctx = canvas.getContext('2d')
	var imgd = ctx.getImageData(0, 0, canvas.width, canvas.height)

	console.log("width:", canvas.width)
	console.log("height:", canvas.height)
	console.log("imgd.data len:", imgd.data.length)

	var s = guetzli_encode_RGBA(imgd.data, canvas.width, canvas.height, 0, 95)
	var q = cToUint8Array(guetzli_string_data(s), guetzli_string_size(s))
	guetzli_string_delete(s)
	return q
}

$(document).ready(function() {
	console.log('showVersion begin')
	$('#guetzli-version').text('guetzli-'+guetzliGetVersion());
	console.log('showVersion end')

	var canvas = document.getElementById('myCanvas')
	var ctx = canvas.getContext('2d')

	ctx.fillStyle = '#663300'
	ctx.fillRect(0, 0, canvas.width, canvas.height)

	var m = new Image()
	m.src = './bees.png'
	m.onload = function() {
		ctx.drawImage(m, 5, 5, canvas.width-10, canvas.height-10)
	}
})

$("#saveAsBtnRun").click(function() {
	console.log('saveAsBtnRun begin')

	let data = encodeImage('myCanvas')
	let blob = new Blob([data.buffer], {type: "application/octet-stream;"})
	saveAs(blob, "guetzli-demo.jpg")

	console.log('saveAsBtnRun end')
})
</script>
</body>
</html>
